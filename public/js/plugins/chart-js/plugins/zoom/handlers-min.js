import{directionEnabled as e,debounce as t,keyNotPressed as o,getModifierKey as n,keyPressed as r}from"./utils.js";import{zoom as i,zoomRect as a}from"./core.js";import{callback as c}from"../../src/helpers/index.js";import{getState as m}from"./state.js";function s(e,t){const{handlers:o}=m(e),n=o[t];n&&n.target&&(n.target.removeEventListener(t,n),delete o[t])}function l(e,t,o,n){const{handlers:r,options:i}=m(e);s(e,o),r[o]=t=>n(e,t,i),r[o].target=t,t.addEventListener(o,r[o])}export function mouseMove(e,t){const o=m(e);o.dragStart&&(o.dragging=!0,o.dragEnd=t,e.update("none"))}function u(e,t,o){const{onZoomStart:n,onZoomRejected:r}=o;if(n){const{left:o,top:i}=t.target.getBoundingClientRect(),a={x:t.clientX-o,y:t.clientY-i};if(!1===c(n,[{chart:e,event:t,point:a}]))return c(r,[{chart:e,event:t}]),!1}}export function mouseDown(e,t){const i=m(e),{pan:a,zoom:s={}}=i.options;if(r(n(a),t)||o(n(s.drag),t))return c(s.onZoomRejected,[{chart:e,event:t}]);!1!==u(e,t,s)&&(i.dragStart=t,l(e,e.canvas,"mousemove",mouseMove))}export function computeDragRect(t,o,n,r){const{left:i,top:a}=n.target.getBoundingClientRect(),c=e(o,"x",t),m=e(o,"y",t);let{top:s,left:l,right:u,bottom:d,width:h,height:p}=t.chartArea;c&&(l=Math.min(n.clientX,r.clientX)-i,u=Math.max(n.clientX,r.clientX)-i),m&&(s=Math.min(n.clientY,r.clientY)-a,d=Math.max(n.clientY,r.clientY)-a);const g=u-l,f=d-s;return{left:l,top:s,right:u,bottom:d,width:g,height:f,zoomX:c&&g?1+(h-g)/h:1,zoomY:m&&f?1+(p-f)/p:1}}export function mouseUp(t,o){const n=m(t);if(!n.dragStart)return;s(t,"mousemove");const{mode:r,onZoomComplete:i,drag:{threshold:l=0}}=n.options.zoom,u=computeDragRect(t,r,n.dragStart,o),d=e(r,"x",t)?u.width:0,h=e(r,"y",t)?u.height:0,p=Math.sqrt(d*d+h*h);if(n.dragStart=n.dragEnd=null,p<=l)return n.dragging=!1,void t.update("none");a(t,{x:u.left,y:u.top},{x:u.right,y:u.bottom},"zoom"),setTimeout((()=>n.dragging=!1),500),c(i,[{chart:t}])}export function wheel(e,t){const{handlers:{onZoomComplete:r},options:{zoom:a}}=m(e);if(!function(e,t,r){if(o(n(r.wheel),t))c(r.onZoomRejected,[{chart:e,event:t}]);else if(!1!==u(e,t,r)&&(t.cancelable&&t.preventDefault(),void 0!==t.deltaY))return!0}(e,t,a))return;const s=t.target.getBoundingClientRect(),l=1+(t.deltaY>=0?-a.wheel.speed:a.wheel.speed),d={x:l,y:l,focalPoint:{x:t.clientX-s.left,y:t.clientY-s.top}};i(e,d),r&&r()}export function addListeners(e,o){const n=e.canvas,{wheel:r,drag:i,onZoomComplete:a}=o.zoom;r.enabled?(l(e,n,"wheel",wheel),function(e,o,n,r){n&&(m(e).handlers[o]=t((()=>c(n,[{chart:e}])),r))}(e,"onZoomComplete",a,250)):s(e,"wheel"),i.enabled?(l(e,n,"mousedown",mouseDown),l(e,n.ownerDocument,"mouseup",mouseUp)):(s(e,"mousedown"),s(e,"mousemove"),s(e,"mouseup"))}export function removeListeners(e){s(e,"mousedown"),s(e,"mousemove"),s(e,"mouseup"),s(e,"wheel"),s(e,"click")}