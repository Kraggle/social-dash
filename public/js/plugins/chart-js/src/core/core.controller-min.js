import t from"./core.animator.js";import e,{overrides as s}from"./core.defaults.js";import a from"./core.interaction.js";import i from"./core.layouts.js";import{_detectPlatform as n}from"../platform/index.js";import o from"./core.plugins.js";import r from"./core.registry.js";import l,{determineAxis as d,getIndexAxis as c}from"./core.config.js";import{retinaScale as h,_isDomSupported as p}from"../helpers/helpers.dom.js";import{each as u,callback as f,uid as g,valueOrDefault as v,_elementsEqual as m,isNullOrUndef as _,setsEqual as y,defined as b}from"../helpers/helpers.core.js";import{clearCanvas as x,clipArea as D,unclipArea as E,_isPointInArea as w}from"../helpers/helpers.canvas.js";import{debounce as M}from"../helpers/helpers.extras.js";const P=["top","bottom","left","right","chartArea"];function z(t,e){return"top"===t||"bottom"===t||-1===P.indexOf(t)&&"x"===e}function R(t,e){return function(s,a){return s[t]===a[t]?s[e]-a[e]:s[t]-a[t]}}function S(t){const e=t.chart,s=e.options.animation;e.notifyPlugins("afterRender"),f(s&&s.onComplete,[t],e)}function I(t){const e=t.chart,s=e.options.animation;f(s&&s.onProgress,[t],e)}function A(t){return p()&&"string"==typeof t?t=document.getElementById(t):t&&t.length&&(t=t[0]),t&&t.canvas&&(t=t.canvas),t}const j={},L=t=>{const e=A(t);return Object.values(j).filter((t=>t.canvas===e)).pop()};class U{constructor(e,s){const a=this,i=this.config=new l(s),r=A(e),d=L(r);if(d)throw new Error("Canvas is already in use. Chart with ID '"+d.id+"' must be destroyed before the canvas can be reused.");const c=i.createResolver(i.chartOptionScopes(),a.getContext());this.platform=new(i.platform||n(r));const h=a.platform.acquireContext(r,c.aspectRatio),p=h&&h.canvas,u=p&&p.height,f=p&&p.width;this.id=g(),this.ctx=h,this.canvas=p,this.width=f,this.height=u,this._options=c,this._aspectRatio=this.aspectRatio,this._layers=[],this._metasets=[],this._stacks=void 0,this.boxes=[],this.currentDevicePixelRatio=void 0,this.chartArea=void 0,this._active=[],this._lastEvent=void 0,this._listeners={},this._responsiveListeners=void 0,this._sortedMetasets=[],this.scales={},this.scale=void 0,this._plugins=new o,this.$proxies={},this._hiddenIndices={},this.attached=!1,this._animationsDisabled=void 0,this.$context=void 0,this._doResize=M((()=>this.update("resize")),c.resizeDelay||0),j[a.id]=a,h&&p&&(t.listen(a,"complete",S),t.listen(a,"progress",I),a._initialize(),a.attached&&a.update())}get aspectRatio(){const{options:{aspectRatio:t,maintainAspectRatio:e},width:s,height:a,_aspectRatio:i}=this;return _(t)?e&&i?i:a?s/a:null:t}get data(){return this.config.data}set data(t){this.config.data=t}get options(){return this._options}set options(t){this.config.options=t}_initialize(){const t=this;return t.notifyPlugins("beforeInit"),t.options.responsive?t.resize():h(t,t.options.devicePixelRatio),t.bindEvents(),t.notifyPlugins("afterInit"),t}clear(){return x(this.canvas,this.ctx),this}stop(){return t.stop(this),this}resize(e,s){t.running(this)?this._resizeBeforeDraw={width:e,height:s}:this._resize(e,s)}_resize(t,e){const s=this,a=s.options,i=s.canvas,n=a.maintainAspectRatio&&s.aspectRatio,o=s.platform.getMaximumSize(i,t,e,n),r=a.devicePixelRatio||s.platform.getDevicePixelRatio();s.width=o.width,s.height=o.height,s._aspectRatio=s.aspectRatio,h(s,r,!0)&&(s.notifyPlugins("resize",{size:o}),f(a.onResize,[s,o],s),s.attached&&s._doResize()&&s.render())}ensureScalesHaveIDs(){const t=this.options.scales||{};u(t,((t,e)=>{t.id=e}))}buildOrUpdateScales(){const t=this,e=t.options,s=e.scales,a=t.scales,n=Object.keys(a).reduce(((t,e)=>(t[e]=!1,t)),{});let o=[];s&&(o=o.concat(Object.keys(s).map((t=>{const e=s[t],a=d(t,e),i="r"===a,n="x"===a;return{options:e,dposition:i?"chartArea":n?"bottom":"left",dtype:i?"radialLinear":n?"category":"linear"}})))),u(o,(s=>{const i=s.options,o=i.id,l=d(o,i),c=v(i.type,s.dtype);void 0!==i.position&&z(i.position,l)===z(s.dposition)||(i.position=s.dposition),n[o]=!0;let h=null;if(o in a&&a[o].type===c)h=a[o];else{h=new(r.getScale(c))({id:o,type:c,ctx:t.ctx,chart:t}),a[h.id]=h}h.init(i,e)})),u(n,((t,e)=>{t||delete a[e]})),u(a,(e=>{i.configure(t,e,e.options),i.addBox(t,e)}))}_updateMetasets(){const t=this,e=t._metasets,s=t.data.datasets.length,a=e.length;if(e.sort(((t,e)=>t.index-e.index)),a>s){for(let e=s;e<a;++e)t._destroyDatasetMeta(e);e.splice(s,a-s)}t._sortedMetasets=e.slice(0).sort(R("order","index"))}_removeUnreferencedMetasets(){const t=this,{_metasets:e,data:{datasets:s}}=t;e.length>s.length&&delete t._stacks,e.forEach(((e,a)=>{0===s.filter((t=>t===e._dataset)).length&&t._destroyDatasetMeta(a)}))}buildOrUpdateControllers(){const t=this,s=[],a=t.data.datasets;let i,n;for(t._removeUnreferencedMetasets(),i=0,n=a.length;i<n;i++){const n=a[i];let o=t.getDatasetMeta(i);const l=n.type||t.config.type;if(o.type&&o.type!==l&&(t._destroyDatasetMeta(i),o=t.getDatasetMeta(i)),o.type=l,o.indexAxis=n.indexAxis||c(l,t.options),o.order=n.order||0,o.index=i,o.label=""+n.label,o.visible=t.isDatasetVisible(i),o.controller)o.controller.updateIndex(i),o.controller.linkScales();else{const a=r.getController(l),{datasetElementType:n,dataElementType:d}=e.datasets[l];Object.assign(a.prototype,{dataElementType:r.getElement(d),datasetElementType:n&&r.getElement(n)}),o.controller=new a(t,i),s.push(o.controller)}}return t._updateMetasets(),s}_resetElements(){const t=this;u(t.data.datasets,((e,s)=>{t.getDatasetMeta(s).controller.reset()}),t)}reset(){this._resetElements(),this.notifyPlugins("reset")}update(t){const e=this,s=e.config;s.update(),e._options=s.createResolver(s.chartOptionScopes(),e.getContext()),u(e.scales,(t=>{i.removeBox(e,t)}));const a=e._animationsDisabled=!e.options.animation;e.ensureScalesHaveIDs(),e.buildOrUpdateScales();const n=new Set(Object.keys(e._listeners)),o=new Set(e.options.events);if(y(n,o)&&!!this._responsiveListeners===e.options.responsive||(e.unbindEvents(),e.bindEvents()),e._plugins.invalidate(),!1===e.notifyPlugins("beforeUpdate",{mode:t,cancelable:!0}))return;const r=e.buildOrUpdateControllers();e.notifyPlugins("beforeElementsUpdate");let l=0;for(let t=0,s=e.data.datasets.length;t<s;t++){const{controller:s}=e.getDatasetMeta(t),i=!a&&-1===r.indexOf(s);s.buildOrUpdateElements(i),l=Math.max(+s.getMaxOverflow(),l)}e._minPadding=l,e._updateLayout(l),a||u(r,(t=>{t.reset()})),e._updateDatasets(t),e.notifyPlugins("afterUpdate",{mode:t}),e._layers.sort(R("z","_idx")),e._lastEvent&&e._eventHandler(e._lastEvent,!0),e.render()}_updateLayout(t){const e=this;if(!1===e.notifyPlugins("beforeLayout",{cancelable:!0}))return;i.update(e,e.width,e.height,t);const s=e.chartArea,a=s.width<=0||s.height<=0;e._layers=[],u(e.boxes,(t=>{a&&"chartArea"===t.position||(t.configure&&t.configure(),e._layers.push(...t._layers()))}),e),e._layers.forEach(((t,e)=>{t._idx=e})),e.notifyPlugins("afterLayout")}_updateDatasets(t){const e=this,s="function"==typeof t;if(!1!==e.notifyPlugins("beforeDatasetsUpdate",{mode:t,cancelable:!0})){for(let a=0,i=e.data.datasets.length;a<i;++a)e._updateDataset(a,s?t({datasetIndex:a}):t);e.notifyPlugins("afterDatasetsUpdate",{mode:t})}}_updateDataset(t,e){const s=this,a=s.getDatasetMeta(t),i={meta:a,index:t,mode:e,cancelable:!0};!1!==s.notifyPlugins("beforeDatasetUpdate",i)&&(a.controller._update(e),i.cancelable=!1,s.notifyPlugins("afterDatasetUpdate",i))}render(){const e=this;!1!==e.notifyPlugins("beforeRender",{cancelable:!0})&&(t.has(e)?e.attached&&!t.running(e)&&t.start(e):(e.draw(),S({chart:e})))}draw(){const t=this;let e;if(t._resizeBeforeDraw){const{width:e,height:s}=t._resizeBeforeDraw;t._resize(e,s),t._resizeBeforeDraw=null}if(t.clear(),t.width<=0||t.height<=0)return;if(!1===t.notifyPlugins("beforeDraw",{cancelable:!0}))return;const s=t._layers;for(e=0;e<s.length&&s[e].z<=0;++e)s[e].draw(t.chartArea);for(t._drawDatasets();e<s.length;++e)s[e].draw(t.chartArea);t.notifyPlugins("afterDraw")}_getSortedDatasetMetas(t){const e=this._sortedMetasets,s=[];let a,i;for(a=0,i=e.length;a<i;++a){const i=e[a];t&&!i.visible||s.push(i)}return s}getSortedVisibleDatasetMetas(){return this._getSortedDatasetMetas(!0)}_drawDatasets(){const t=this;if(!1===t.notifyPlugins("beforeDatasetsDraw",{cancelable:!0}))return;const e=t.getSortedVisibleDatasetMetas();for(let s=e.length-1;s>=0;--s)t._drawDataset(e[s]);t.notifyPlugins("afterDatasetsDraw")}_drawDataset(t){const e=this,s=e.ctx,a=t._clip,i=!a.disabled,n=e.chartArea,o={meta:t,index:t.index,cancelable:!0};!1!==e.notifyPlugins("beforeDatasetDraw",o)&&(i&&D(s,{left:!1===a.left?0:n.left-a.left,right:!1===a.right?e.width:n.right+a.right,top:!1===a.top?0:n.top-a.top,bottom:!1===a.bottom?e.height:n.bottom+a.bottom}),t.controller.draw(),i&&E(s),o.cancelable=!1,e.notifyPlugins("afterDatasetDraw",o))}getElementsAtEventForMode(t,e,s,i){const n=a.modes[e];return"function"==typeof n?n(this,t,s,i):[]}getDatasetMeta(t){const e=this.data.datasets[t],s=this._metasets;let a=s.filter((t=>t&&t._dataset===e)).pop();return a||(a={type:null,data:[],dataset:null,controller:null,hidden:null,xAxisID:null,yAxisID:null,order:e&&e.order||0,index:t,_dataset:e,_parsed:[],_sorted:!1},s.push(a)),a}getContext(){return this.$context||(this.$context={chart:this,type:"chart"})}getVisibleDatasetCount(){return this.getSortedVisibleDatasetMetas().length}isDatasetVisible(t){const e=this.data.datasets[t];if(!e)return!1;const s=this.getDatasetMeta(t);return"boolean"==typeof s.hidden?!s.hidden:!e.hidden}setDatasetVisibility(t,e){this.getDatasetMeta(t).hidden=!e}toggleDataVisibility(t){this._hiddenIndices[t]=!this._hiddenIndices[t]}getDataVisibility(t){return!this._hiddenIndices[t]}_updateVisibility(t,e,s){const a=this,i=s?"show":"hide",n=a.getDatasetMeta(t),o=n.controller._resolveAnimations(void 0,i);b(e)?(n.data[e].hidden=!s,a.update()):(a.setDatasetVisibility(t,s),o.update(n,{visible:s}),a.update((e=>e.datasetIndex===t?i:void 0)))}hide(t,e){this._updateVisibility(t,e,!1)}show(t,e){this._updateVisibility(t,e,!0)}_destroyDatasetMeta(t){const e=this,s=e._metasets&&e._metasets[t];s&&s.controller&&(s.controller._destroy(),delete e._metasets[t])}destroy(){const e=this,{canvas:s,ctx:a}=e;let i,n;for(e.stop(),t.remove(e),i=0,n=e.data.datasets.length;i<n;++i)e._destroyDatasetMeta(i);e.config.clearCache(),s&&(e.unbindEvents(),x(s,a),e.platform.releaseContext(a),e.canvas=null,e.ctx=null),e.notifyPlugins("destroy"),delete j[e.id]}toBase64Image(...t){return this.canvas.toDataURL(...t)}bindEvents(){this.bindUserEvents(),this.options.responsive?this.bindResponsiveEvents():this.attached=!0}bindUserEvents(){const t=this,e=t._listeners,s=t.platform,a=function(e,s,a){e.offsetX=s,e.offsetY=a,t._eventHandler(e)};u(t.options.events,(i=>((a,i)=>{s.addEventListener(t,a,i),e[a]=i})(i,a)))}bindResponsiveEvents(){const t=this;t._responsiveListeners||(t._responsiveListeners={});const e=t._responsiveListeners,s=t.platform,a=(a,i)=>{s.addEventListener(t,a,i),e[a]=i},i=(a,i)=>{e[a]&&(s.removeEventListener(t,a,i),delete e[a])},n=(e,s)=>{t.canvas&&t.resize(e,s)};let o;const r=()=>{i("attach",r),t.attached=!0,t.resize(),a("resize",n),a("detach",o)};o=()=>{t.attached=!1,i("resize",n),a("attach",r)},s.isAttached(t.canvas)?r():o()}unbindEvents(){const t=this;u(t._listeners,((e,s)=>{t.platform.removeEventListener(t,s,e)})),t._listeners={},u(t._responsiveListeners,((e,s)=>{t.platform.removeEventListener(t,s,e)})),t._responsiveListeners=void 0}updateHoverStyle(t,e,s){const a=s?"set":"remove";let i,n,o,r;for("dataset"===e&&(i=this.getDatasetMeta(t[0].datasetIndex),i.controller["_"+a+"DatasetHoverStyle"]()),o=0,r=t.length;o<r;++o){n=t[o];const e=n&&this.getDatasetMeta(n.datasetIndex).controller;e&&e[a+"HoverStyle"](n.element,n.datasetIndex,n.index)}}getActiveElements(){return this._active||[]}setActiveElements(t){const e=this,s=e._active||[],a=t.map((({datasetIndex:t,index:s})=>{const a=e.getDatasetMeta(t);if(!a)throw new Error("No dataset found at index "+t);return{datasetIndex:t,element:a.data[s],index:s}}));!m(a,s)&&(e._active=a,e._updateHoverStyles(a,s))}notifyPlugins(t,e,s){return this._plugins.notify(this,t,e,s)}_updateHoverStyles(t,e,s){const a=this,i=a.options.hover,n=(t,e)=>t.filter((t=>!e.some((e=>t.datasetIndex===e.datasetIndex&&t.index===e.index)))),o=n(e,t),r=s?t:n(t,e);o.length&&a.updateHoverStyle(o,i.mode,!1),r.length&&i.mode&&a.updateHoverStyle(r,i.mode,!0)}_eventHandler(t,e){const s=this,a={event:t,replay:e,cancelable:!0},i=e=>(e.options.events||this.options.events).includes(t.type);if(!1===s.notifyPlugins("beforeEvent",a,i))return;const n=s._handleEvent(t,e);return a.cancelable=!1,s.notifyPlugins("afterEvent",a,i),(n||a.changed)&&s.render(),s}_handleEvent(t,e){const s=this,{_active:a=[],options:i}=s,n=i.hover,o=e;let r=[],l=!1,d=null;return"mouseout"!==t.type&&(r=s.getElementsAtEventForMode(t,n.mode,n,o),d="click"===t.type?s._lastEvent:t),s._lastEvent=null,w(t,s.chartArea,s._minPadding)&&(f(i.onHover,[t,r,s],s),"mouseup"!==t.type&&"click"!==t.type&&"contextmenu"!==t.type||f(i.onClick,[t,r,s],s)),l=!m(r,a),(l||e)&&(s._active=r,s._updateHoverStyles(r,a,e)),s._lastEvent=d,l}}const O=()=>u(U.instances,(t=>t._plugins.invalidate()));Object.defineProperties(U,{defaults:{enumerable:true,value:e},instances:{enumerable:true,value:j},overrides:{enumerable:true,value:s},registry:{enumerable:true,value:r},version:{enumerable:true,value:"3.5.0"},getChart:{enumerable:true,value:L},register:{enumerable:true,value:(...t)=>{r.add(...t),O()}},unregister:{enumerable:true,value:(...t)=>{r.remove(...t),O()}}});export default U;